import MDXRenderer from "../components/MDXRenderer";
import CommentaryLayout from "./CommentaryLayout";
import StyledLink from "../components/StyledLink";
import H2WithHash from "../components/H2WithHash";

Hotwireで一番最初に紹介する技術は[Turbo Drive](https://turbo.hotwired.dev/handbook/drive)です。Turbo Driveはページ遷移のUXを大幅に向上させます。

ウェブの根幹をなすのはリンクです。ウェブの最も基本的でかつ重要な動作は、リンクをクリックした後のページの遷移です。それだけにUXへのインパクトが大きいものです。

<p className="my-2 text-sm text-gray-600">※ ここでは最初にサイトを訪問した時のUXではなく、サイト内のリンクをクリックしたときの動作にフォーカスします</p>

<div className="mt-8 flow-root">
  <div className="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
    <div className="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
      <table className="min-w-full divide-y divide-gray-300">
        <caption className="caption-top text-left font-bold">ページ遷移技術の比較</caption>
        <thead>
        <tr>
          <th scope="col"
              className="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-3">
            技術
          </th>
          <th scope="col" className="min-w-28 px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
            データロード
          </th>
          <th scope="col" className="min-w-28 px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
            ローダー表示
          </th>
          <th scope="col" className="min-w-28 px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
            prefetch
          </th>
          <th scope="col" className="min-w-28 px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
            セキュリティ
          </th>
          <th scope="col" className="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
            その他
          </th>
        </tr>
        </thead>
        <tbody className="bg-white">
        <tr key={1} className="even:bg-gray-50">
          <td className="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-3">
            [ネイティブ(MPA)](/api/hotwire/users)
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            先にロード
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            する
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            しない
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            ○
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            JavaScript, CSSは要再読み込み
          </td>
        </tr>
        <tr key={2} className="even:bg-gray-50">
          <td className="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-3">
            [Hotwire (Turbo Drive)](/api/hotwire/users)
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            先にロード
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            <StyledLink
              href="https://turbo.hotwired.dev/handbook/drive#displaying-progress">する</StyledLink>
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            <StyledLink
              href="https://turbo.hotwired.dev/handbook/drive#prefetching-links-on-hover">する</StyledLink>
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            ○
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            hoverでprefetch
          </td>
        </tr>
        <tr key={3} className="even:bg-gray-50">
          <td className="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-3">
            [Next SSG](/users_ssg)
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            先にロード
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            要作成
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            <StyledLink
              href="https://nextjs.org/docs/pages/api-reference/components/link#prefetch">する</StyledLink>
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            △ (要DAL)
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            動的なサイトでは使えないが、参考までに紹介
          </td>
        </tr>
        <tr key={4} className="even:bg-gray-50">
          <td className="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-3">
            [Next useEffect](/users)
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            後にロード
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            要作成
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            <StyledLink
              href="https://nextjs.org/docs/pages/api-reference/components/link#prefetch">静的な部分まで</StyledLink>
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            △ (要DAL)
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            useEffect内のfetchはprefetchされない
          </td>
        </tr>
        <tr key={5} className="even:bg-gray-50">
          <td className="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-3">
            [Next page router SSR](/users_ssr)
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            先にロード
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            要作成
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            しない
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            △ (要DAL)
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            SSRを使うとprefetchしない
          </td>
        </tr>
        <tr key={6} className="even:bg-gray-50">
          <td className="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-3">
            [Next app router Server component](/users_app)
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            先にロード
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            要作成
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            <StyledLink
              href="https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#2-prefetching">静的な部分まで</StyledLink>
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            △ (要DAL)
          </td>
          <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
            dynamic componentを使った場合はloading.jsのところまでprefetch
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<H2WithHash id="installing-turbo">Turboのインストール</H2WithHash>

Hotwireは[Turbo](https://turbo.hotwired.dev)/[Stimulus](https://stimulus.hotwired.dev)/[Strada](https://strada.hotwired.dev)の３つのパーツからなっています。ウェブで使用するのはTurboとStimulusですが、双方ともJavaScriptのファイルを読み込むだけで使用できます。ここでは[Turbo Drive](https://turbo.hotwired.dev/handbook/drive)を使用しますので、TurboのJavaScriptファイルを読み込みます。

**普通のMPAのページにTurboをインストールするだけで、Turbo Driveによる画面遷移が手に入ります。** インストール方法はファイルを読み込むだけです。[公式ドキュメント](https://turbo.hotwired.dev/handbook/installing)を確認してください。

本サイトではnpm等を使用せずに、コンパイル済みのJavaScriptファイルをダウンロードしてインストールしました。TurboのJavaScriptファイルは`public/hotwire/javascript/turbo.es2017-esm.js`にダウンロードされており、`templates/layouts/header.ejs`から参照されています。

<H2WithHash id="page-transition-ux">ページ遷移のUX</H2WithHash>

本サイトでは、各技術を使った際のUXを確認していただくために、デモを用意しています。上の表の各技術名をクリックして、実際にUXをご体験ください。

### SPAの効果

上記の表に挙げた技術は、ネイティブを除いて、全てSPA ([Single-page Application: シングルページアプリケーション](https://ja.wikipedia.org/wiki/シングルページアプリケーション))です。Next.jsの場合はSSRであっても、２つ目のページはSPA的に遷移します。

ここでいうSPA的というのは、ページ切り替え時に[AJAX](https://ja.wikipedia.org/wiki/Ajax)等を使っていて、一見するとページ全体は切り替わっているものの、裏でロードされたJavaScriptやCSSはそのまま残しているという意味です。先のページのメモリ等を残しているため、よりスムーズなページ切り替えが可能になり、またキャッシュなどのパフォーマンス最適化の工夫がしやすくなっています。

ただし最近の高性能マシンではJavaScriptやCSSを読み込まないことによる効果はわずかであり、ほとんど感じることができません。実際[Astro](https://astro.build)などのフレームワークはSSRをするものの、２ページ目のSPA的遷移は省略しています。

SPA的な画面遷移の効果を強く感じさせてくれるのは、次に紹介するprefetchと組み合わせた時です。

### Prefetchの効果

[Turbo Driveをインストール](#installing-turbo)するだけで、ページ遷移はヌルサクになります。ネイティブな画面遷移]とTurbo Driveによる[画面遷移を比べていただくと](/api/hotwire/users)一目瞭然です。

この効果のほとんどは[prefetch](https://turbo.hotwired.dev/handbook/drive#prefetching-links-on-hover)によるものです。マウスカーソルがリンクの上をホバーした時に、**フライング**をしてサーバにリクエストを飛ばします。そして実際にユーザがリンクをクリックしたとき、すでにリンク先ページは読み込まれていますので、瞬間的に画面遷移ができます。

### Next.jsのprefetchは条件によっては動かない

Next.jsにもprefetchがあります。しかし多くのケースでは効果がありません。Pages routerの場合、SSRされるページではprefetchは効果がありません。またApp routerの場合は最初の`loading.js`ファイルまでしかprefetchしませんので、[prefetchはローディング画面の表示を早めてくれるだけ](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#2-prefetching)の効果しかありません。

本サイトの例を見ても、[Next SSGの場合](/users_ssg)は最後まで瞬間的な画面遷移をしますが、[Next useEffect](/users)、[Next app router](/users_app)の場合はローダー画面だけが瞬間的に表示され、データのある画面はこれ

export default function({children}) {
  return <CommentaryLayout
    title="Page Transitions"
    subtitle="ページ遷移"
    section="Commentary">
    <MDXRenderer>{children}</MDXRenderer>
  </CommentaryLayout>
}
