# TurboFrames: ポップアップ

## JavaScriptを組み合わせる

[タブメニュー](tabbed-ui.md)では、ウェブUIの多くは「枠」が重要であるとした上で、TurboFramesを使うと「枠」の中にサーバレスポンスを簡単に挿し込めることを説明した。

ここではさらにTurboFramesと少しのJavaScriptを組み合わせる方法を紹介し、ポップアップを実装する。

## JavaScriptの書き方

ポップアップの表示・非表示を行うために、React側では[条件付きレンダー](https://ja.react.dev/learn/conditional-rendering)を使用した。 またHotwire側では`<body>`の中に`<script>`タグを埋め込み、`showPopup()`と`hideAllPopups()`の関数を用意した。

今回のケースはこれで問題はないが、非同期的に画面を部分的に更新すると管理が難しくなりやすい。またそうでなくても、一般的にJavaScriptの量が増えると、イベントの関係性の見通しが悪くなりやすい。

Hotwireではこの問題を解決するためにStimulusというライブラリーを使うので、Stimulusを使った例も用意した。

## Reactの条件付きレンダー

Reactでは[条件付きレンダー](https://ja.react.dev/learn/conditional-rendering)を使ってUI要素の表示・非表示を制御することが多い。今回も条件付きレンダーを使ってポップアップを生業した。

しかし条件付きレンダーを使うと、非表示の時にコンポーネントをDOMから消し去ってしまうので、ステートを含めてすべてが消えてしまう。`UserPopUp`コンポーネントがサーバから取得したデータがすべてなくなる。そのため、全く同じ`UserPopUp`を表示する場合であっても、最初にローダーを表示するところから始めなければならない。

これに対して通常のJavaScriptでポップアップを制御する場合は、CSSの`display: none`属性で表示・非表示を切り替える。この場合はポップアップはDOMから消えないので、ステートは維持されている。同じポップアップを再度表示するときは、データがすでに読み込まれている状態なので、まずは古いデータを表示し、裏で最新のデータを取得し、最後に差し替えるという処理になる。通常はこちらの動作の方が適切である。(この動作は、ポップアップに表示される時間から確認できる)

CSSの`display: none`属性で表示・非表示を切り替えている場合、古いデータを一切表示したくないケースもあるだろう。その場合はTurboFrameがロードしているときに自動的に付与される`busy`属性をCSSで検出し、ポップアップの内容を非表示にすれば良い。またもう一つの方法としてポップアップの表示・非表示をする時に内容をクリアすることもできる。

